# -*- coding: utf-8 -*-
import pandas as pd
from datetime import datetime
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, roc_curve, auc
import seaborn as sns
import jieba
import re
from collections import Counter
from sklearn.feature_extraction.text import TfidfVectorizer
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
from sentence_transformers import SentenceTransformer


df_raw = pd.read_csv("../processed_data/data.csv", encoding='utf-8')
job_code = pd.read_csv("../processed_data/job_code.csv", encoding='utf-8')

df = df_raw.iloc[1:].reset_index(drop=True)
df.replace('\\N', pd.NA, inplace=True)

today = pd.to_datetime(datetime.today().date())

date_cols = [
    'b_acc031', # 就业时间
    'b_aae031', # 合同终止日期
    'c_acc028' # 失业注销时间
]
for col in date_cols:
    df[col] = pd.to_datetime(df[col], errors='coerce')

df['label'] = 0
df.loc[df['c_acc0m3'] == '就业', 'label'] = 1
df.loc[df['b_acc031'].notna() & (df['b_aae031'].isna() | (df['b_aae031'] > today)),'label'] = 1
df.loc[df['c_acc028'].notna(), 'label'] = 1

job_code = job_code.rename(columns={
    '行业代码': 'b_aab022',
    '注释': 'job_name'})

df = pd.merge(df, job_code[['b_aab022', 'job_name']], how='left', on='b_aab022')
df = df.drop(columns=['b_aab022'])

df_filtered = df[df['label'] == 0]

print(df_filtered.columns)

df_resume = df_filtered[["c_aac180", "c_aac183", "b_aab004", "job_name"]].copy()
df_resume = df_resume.copy()
df_resume.loc[:, '简历文本'] = df_resume.fillna('').astype(str).agg(' '.join, axis=1)
df_resume = df_resume[["c_aac183", "c_aac180", "b_aab004", "job_name", "简历文本"]]

new_column_names = {
    "c_aac183": "所学专业名称",
    "c_aac180": "毕业学校",
    "b_aab004": "前公司",
    "job_name": "行业名称",
    "简历文本": "简历文本"}

df_resume = df_resume.rename(columns=new_column_names)

# 增加岗位数据
data = [
    {
        "岗位名称": "会计",
        "岗位职责": "全面负责公司财务报表的编制与分析工作，确保报表数据的准确性和及时性，为公司决策提供有力支持。处理日常账务核算，包括审核各类原始凭证、编制记账凭证、登记账簿等。准确计算并及时缴纳各项税费，熟悉税务申报流程和相关税收政策，与税务机关保持良好沟通。定期进行财务数据的统计与分析，为管理层提供财务状况和经营成果的详细报告。协助审计机构完成年度审计工作，提供相关财务资料和解释。",
        "任职要求": "具备会计相关证书，如注册会计师（CPA）、注册税务师（CTA）等优先。熟悉国家财务、税务法规和政策，熟练掌握报税流程和财务软件的使用。具有扎实的会计专业知识和丰富的财务工作经验，能够独立完成财务核算和报表编制工作。具备良好的数据分析能力和财务风险意识，能够发现并解决财务工作中的问题。工作认真负责，严谨细致，具有良好的职业道德和团队合作精神。"
    },
    {
        "岗位名称": "客服专员",
        "岗位职责": "热情、专业地接待用户咨询，通过电话、邮件、在线聊天等多种渠道及时响应用户需求，解决用户问题。详细记录用户反馈的问题和建议，建立用户问题档案，为后续的服务改进提供依据。跟进用户问题的处理进度，及时向用户反馈处理结果，确保用户满意度。积极收集用户对产品或服务的意见和建议，为产品优化和服务提升提供有价值的信息。处理用户投诉和纠纷，以专业的态度和有效的沟通技巧化解矛盾，维护公司良好的品牌形象。",
        "任职要求": "具备良好的沟通能力和语言表达能力，能够清晰、准确地与用户进行交流。拥有高度的耐心和责任心，能够认真倾听用户的诉求，积极解决用户问题。具备较强的服务意识和应变能力，能够在面对用户的不满和投诉时保持冷静，妥善处理。熟悉公司产品或服务的特点和优势，能够为用户提供准确的信息和解决方案。熟练使用办公软件和客服管理系统，具备良好的文字录入和数据处理能力。"
    },
    {
        "岗位名称": "产品经理",
        "岗位职责": "负责公司产品的整体规划和战略制定，结合市场需求和公司发展目标，确定产品的定位和发展方向。组织开展市场调研和竞品分析，深入了解市场动态和用户需求，为产品的优化和创新提供依据。协调公司内部各部门资源，推动产品的开发、上线和迭代更新，确保产品按时交付并达到预期目标。制定产品的营销策略和推广方案，与市场、销售团队紧密合作，提升产品的市场占有率和用户满意度。收集和分析产品的用户反馈和数据指标，持续优化产品的功能和体验，提高产品的竞争力。",
        "任职要求": "具备一定的项目管理经验，能够有效地组织和协调团队资源，推动项目的顺利进行。拥有较强的沟通能力和团队协作精神，能够与不同部门的人员进行良好的沟通和合作。具备敏锐的市场洞察力和用户需求分析能力，能够准确把握市场趋势和用户痛点。熟悉产品开发流程和方法，具备良好的产品设计和规划能力。具有较强的数据分析能力，能够通过数据驱动产品决策，优化产品性能。"
    },
    {
        "岗位名称": "UI设计师",
        "岗位职责": "负责公司软件产品的界面设计工作，包括界面布局、色彩搭配、图标设计等，提升用户体验和产品的视觉吸引力。与产品、开发团队紧密合作，深入了解产品需求和用户场景，提供符合用户需求和产品定位的设计方案。进行用户界面的原型设计和交互设计，通过原型演示和用户测试，不断优化设计方案。关注行业动态和设计趋势，将最新的设计理念和方法应用到产品设计中，提升产品的设计水平。参与公司品牌形象设计和宣传物料的设计工作，确保公司品牌形象的一致性和专业性。",
        "任职要求": "熟练掌握设计工具，如Adobe Photoshop、Sketch、Figma等，具备良好的手绘能力和美术功底。拥有较强的创新能力和审美能力，能够设计出具有独特风格和吸引力的界面。具备良好的沟通能力和团队协作精神，能够与产品、开发团队进行有效的沟通和合作。熟悉用户体验设计原则和方法，能够从用户角度出发进行设计，提高产品的易用性和满意度。具有较强的学习能力和自我驱动力，能够不断学习和掌握新的设计技术和方法。"
    },
    {
        "岗位名称": "销售经理",
        "岗位职责": "制定并执行公司的销售策略和销售计划，带领销售团队完成销售目标。负责销售团队的管理和培训，提升团队成员的销售能力和业务水平。建立和维护良好的客户关系，深入了解客户需求，为客户提供优质的产品和服务解决方案。分析市场动态和竞争对手情况，及时调整销售策略和销售计划，提高公司的市场竞争力。组织和参与各类销售活动和商务谈判，拓展销售渠道和客户资源，推动业务的持续增长。",
        "任职要求": "具有较强的销售能力和市场开拓能力，能够带领团队完成销售目标。拥有丰富的销售管理经验，能够有效地管理和激励销售团队，提高团队的工作效率和业绩。具备良好的沟通能力和商务谈判技巧，能够与客户建立长期稳定的合作关系。熟悉所在行业的市场情况和客户需求，能够制定针对性的销售策略和解决方案。具有较强的数据分析能力和决策能力，能够通过数据分析为销售决策提供支持。"
    },
    {
        "岗位名称": "HR专员",
        "岗位职责": "负责公司员工的招聘工作，包括制定招聘计划、发布招聘信息、筛选简历、面试安排等，确保招聘到符合公司需求的人才。组织员工培训和发展活动，根据员工的需求和公司的发展战略，制定培训计划并组织实施。负责员工的绩效管理工作，建立和完善绩效管理制度，组织绩效评估和反馈，激励员工提高工作绩效。处理员工关系相关事宜，包括劳动合同管理、劳动纠纷处理、员工关怀等，维护良好的员工关系。参与公司人力资源规划和制度建设，为公司的人力资源管理提供支持和建议。",
        "任职要求": "熟悉人力资源管理流程和相关法律法规，具备扎实的人力资源专业知识。拥有良好的沟通能力和组织协调能力，能够与不同部门的人员进行有效的沟通和合作。具备较强的责任心和服务意识，能够认真对待员工的需求和问题，提供优质的人力资源服务。具有较强的数据分析能力和文字处理能力，能够撰写人力资源相关的报告和文件。具备良好的团队合作精神和学习能力，能够不断提升自己的专业水平和综合素质。"
    },
    {
        "岗位名称": "数据科学家",
        "岗位职责": "负责公司数据的收集、整理和分析工作，通过数据分析为公司决策提供支持和建议。构建和优化数据模型，运用机器学习、深度学习等算法解决实际业务问题，如预测分析、分类分析、聚类分析等。与业务部门紧密合作，深入了解业务需求，将数据模型和分析结果转化为实际业务解决方案。开发和维护数据平台和数据仓库，确保数据的质量和安全性。跟踪和研究数据科学领域的最新技术和方法，将其应用到公司的业务中，提升公司的数据驱动能力。",
        "任职要求": "精通数据分析与机器学习，熟悉常见的机器学习算法和模型，如决策树、神经网络、支持向量机等。具备扎实的数学和统计学基础，能够运用数学方法解决实际问题。拥有丰富的数据分析和建模经验，能够独立完成数据挖掘项目和算法开发。熟练使用编程语言，如Python、R等，以及相关的数据处理和分析工具，如Pandas、NumPy、Scikit-learn等。具备良好的沟通能力和团队协作精神，能够与业务部门和技术团队进行有效的沟通和合作。"
    },
    {
        "岗位名称": "市场分析师",
        "岗位职责": "对市场进行全面深入的调研，包括市场规模、市场趋势、竞争对手情况等，为公司的市场策略制定提供数据支持和分析报告。分析市场数据和信息，运用统计学方法和数据分析工具，挖掘市场机会和潜在风险，为公司的产品定位和营销策略提供建议。跟踪和监测市场动态和竞争对手的活动，及时向公司管理层汇报市场变化情况，为公司的决策提供参考。参与公司的市场推广活动和营销策划，根据市场分析结果制定针对性的推广方案和营销策略。与销售、产品等部门密切合作，共同推动公司业务的发展和市场份额的提升。",
        "任职要求": "具备一定的市场分析能力和数据处理能力，能够运用数据分析工具和方法进行市场调研和分析。熟悉市场调研流程和方法，能够设计和执行有效的市场调研方案。拥有良好的数据分析和报告撰写能力，能够将分析结果以清晰、易懂的方式呈现给管理层。具备较强的逻辑思维能力和问题解决能力，能够从复杂的数据中提取有价值的信息和结论。熟悉所在行业的市场情况和竞争态势，能够对市场趋势进行准确的预测和判断。"
    },
    {
        "岗位名称": "客户经理",
        "岗位职责": "负责维护和拓展客户关系，与客户建立长期稳定的合作关系，提高客户满意度和忠诚度。深入了解客户需求，为客户提供个性化的产品和服务解决方案，推动销售目标的达成。定期拜访客户，了解客户的使用情况和反馈意见，及时解决客户问题，提升客户体验。制定客户营销计划和方案，通过各种营销手段和活动，促进客户的二次购买和业务拓展。协调公司内部各部门资源，为客户提供优质的售前、售中、售后服务，确保客户的需求得到及时满足。",
        "任职要求": "具备良好的客户沟通技巧和销售经验，能够与客户建立良好的合作关系。拥有较强的服务意识和责任心，能够认真对待客户的需求和问题，提供优质的客户服务。具备较强的市场开拓能力和业务拓展能力，能够不断挖掘新的客户资源和业务机会。熟悉公司的产品和服务，能够为客户提供准确的信息和解决方案。具备良好的团队合作精神和沟通协调能力，能够与公司内部各部门进行有效的沟通和合作。"
    },
    {
        "岗位名称": "网络工程师",
        "岗位职责": "负责公司网络设备的配置、维护和管理工作，包括路由器、交换机、防火墙等，确保网络的稳定运行。制定和实施网络安全策略，防范网络攻击和数据泄露，保障公司网络的安全性。进行网络拓扑结构设计和优化，提高网络性能和可靠性。监控网络运行状态，及时发现和解决网络故障，减少网络中断时间。参与公司的信息化建设项目，负责网络部分的规划、实施和验收工作。",
        "任职要求": "了解网络协议，如TCP/IP、HTTP、FTP等，具备网络设备管理经验。熟悉网络安全技术和方法，能够制定和实施有效的网络安全策略。掌握网络拓扑结构设计和优化的方法，能够提高网络的性能和可靠性。熟练使用网络管理工具和网络诊断工具，能够快速定位和解决网络故障。具备良好的沟通能力和团队协作精神，能够与其他部门的人员进行有效的沟通和合作。"
    },
    {
        "岗位名称": "法务专员",
        "岗位职责": "处理公司法务事务，包括合同审查、起草、谈判等，确保合同的合法性和有效性。提供法律咨询服务，为公司各部门提供法律意见和建议，防范法律风险。处理公司的诉讼和仲裁案件，与律师事务所合作，制定诉讼策略，维护公司的合法权益。参与公司的重大决策和项目，从法律角度进行风险评估和合规审查，确保公司的经营活动符合法律法规的要求。开展法律培训和宣传活动，提高公司员工的法律意识和法律素养。",
        "任职要求": "法学相关专业，具有扎实的法律专业知识和丰富的法务工作经验。拥有律师资格证者优先，能够独立处理各类法律事务。熟悉国家法律法规和政策，能够准确把握法律风险和合规要求。具备良好的沟通能力和谈判技巧，能够与外部律师事务所和相关部门进行有效的沟通和合作。具有较强的责任心和保密意识，能够认真对待公司的法律事务，保守公司的商业秘密。"
    },
    {
        "岗位名称": "金融分析师",
        "岗位职责": "对金融市场进行深入分析，包括宏观经济形势、行业动态、金融产品等，预测未来趋势，为公司的投资决策提供支持和建议。研究和评估金融产品的风险和收益特征，为客户提供专业的投资咨询服务。建立和维护金融模型和数据分析工具，通过数据分析和模型预测，为投资决策提供量化支持。跟踪和监测投资组合的表现，及时调整投资策略，确保投资目标的实现。与其他部门合作，参与公司的金融产品开发和推广工作，提供专业的金融分析和建议。",
        "任职要求": "具备金融分析的基本知识，熟悉金融市场和金融产品的特点和风险。熟练使用金融分析工具和软件，如Excel、MATLAB、EViews等，能够进行数据分析和模型构建。拥有丰富的金融分析和投资经验，能够独立完成投资分析报告和投资策略制定。具备较强的数据分析能力和逻辑思维能力，能够从复杂的金融数据中提取有价值的信息和结论。具备良好的沟通能力和团队协作精神，能够与其他部门的人员进行有效的沟通和合作。"
    },
    {
        "岗位名称": "电机结构工程师",
        "岗位职责": "进行电机新品结构设计，根据电机的性能要求和应用场景，设计合理的电机结构和外形。负责电机新平台的设计和开发工作，优化电机的结构设计，提高电机的性能和可靠性。与电机研发团队密切合作，参与电机的电磁设计、热设计等工作，确保电机的整体性能符合要求。进行电机结构的强度分析和优化，运用有限元分析软件等工具，对电机结构进行力学性能分析和优化设计。负责电机结构设计文档的编制和管理工作，包括设计图纸、技术文件等，确保设计文档的完整性和准确性。",
        "任职要求": "机械设计、电气、材料等相关专业，具有扎实的专业知识和丰富的电机结构设计经验。熟悉电机的工作原理和性能要求，能够根据电机的应用场景进行合理的结构设计。掌握机械设计软件，如SolidWorks、ProE、UG等，能够进行三维建模和二维图纸绘制。具备一定的有限元分析能力，能够运用有限元分析软件对电机结构进行力学性能分析和优化设计。具备良好的沟通能力和团队协作精神，能够与其他部门的人员进行有效的沟通和合作。"
    },
    {
        "岗位名称": "PLM高级产品经理",
        "岗位职责": "负责业务调研、需求分析、产品原型设计，深入了解消费电子/大家电/汽车等行业数字化研发体系的业务流程和需求，产出高质量产品说明文档。制定产品的发展战略和规划，结合市场需求和公司发展目标，确定产品的定位和功能特性。协调公司内部各部门资源，推动产品的开发、上线和迭代更新，确保产品按时交付并达到预期目标。与客户和合作伙伴保持密切沟通，收集用户反馈和市场需求，为产品的优化和创新提供依据。组织和参与产品的市场推广和销售活动，提高产品的市场占有率和用户满意度。",
        "任职要求": "对消费电子/大家电/汽车等行业数字化研发体系有深入理解，熟悉行业的发展趋势和技术应用。具备丰富的产品管理经验，能够独立完成产品的规划、设计、开发和推广工作。拥有较强的沟通能力和团队协作精神，能够与不同部门的人员进行良好的沟通和合作。具备良好的需求分析和产品设计能力，能够准确把握用户需求和市场趋势，设计出符合用户需求的产品。具有较强的项目管理能力，能够有效地组织和协调团队资源，推动项目的顺利进行。"
    },
    {
        "岗位名称": "高级人力产品经理",
        "岗位职责": "参与人力领域薪酬管理、预算管理等产品的规划与搭建，深入了解人力资源管理的业务流程和需求，制定产品的功能和特性。负责产品的需求分析、设计和开发工作，与技术团队合作，确保产品的顺利上线和迭代更新。建立和完善产品的运营体系，包括数据监测、用户反馈收集、产品优化等，提高产品的用户满意度和市场竞争力。与其他部门合作，推动产品的推广和应用，提高公司人力资源管理的数字化水平。跟踪和研究人力资源管理领域的最新技术和趋势，将其应用到产品中，提升产品的创新性和竞争力。",
        "任职要求": "具备良好的逻辑思维与沟通表达能力，能够清晰、准确地表达自己的想法和观点。计算机、人力资源管理类专业优先，熟悉人力资源管理流程和相关法律法规。拥有丰富的产品管理经验，能够独立完成产品的规划、设计、开发和运营工作。具备较强的数据分析能力，能够通过数据驱动产品决策，优化产品性能。具备良好的团队合作精神和学习能力，能够不断提升自己的专业水平和综合素质。"
    },
    {
        "岗位名称": "新媒体主管",
        "岗位职责": "针对投诉、舆情的用户，查明投诉原因及用户需求，及时、有效地处理用户投诉和舆情事件，维护公司的品牌形象和声誉。制定和执行新媒体营销策略，通过微信、微博、抖音等新媒体平台进行品牌推广和产品宣传，提高公司的知名度和影响力。策划和组织新媒体活动，如线上直播、互动话题等，吸引用户关注和参与，增加用户粘性和活跃度。分析新媒体数据和用户反馈，了解用户需求和市场趋势，优化新媒体营销策略和内容。管理新媒体团队，包括人员招聘、培训、绩效考核等，提高团队的工作效率和业务水平。",
        "任职要求": "逻辑思维清晰，具备较强服务意识和应变能力，能够在面对突发舆情事件时保持冷静，妥善处理。熟悉新媒体平台的运营规则和特点，能够制定针对性的新媒体营销策略。拥有丰富的新媒体运营经验，能够独立完成新媒体活动的策划、组织和执行工作。具备良好的沟通能力和团队协作精神，能够与不同部门的人员进行有效的沟通和合作。具备较强的数据分析能力，能够通过数据分析优化新媒体运营效果。"
    },
    {
        "岗位名称": "一线服务专员",
        "岗位职责": "负责销售、金融保险、产品等业务的推广和销售工作，向客户介绍产品的特点和优势，促成交易。为客户提供基础售后服务咨询，解答客户关于产品使用、保养、维修等方面的问题，提高客户满意度。收集客户反馈和市场信息，及时向公司反馈客户需求和市场动态，为公司的产品优化和服务提升提供依据。处理客户投诉和纠纷，以专业的态度和有效的沟通技巧化解矛盾，维护公司良好的品牌形象。协助团队完成销售目标和任务，积极参与团队的各项活动和培训。",
        "任职要求": "具备良好的服务意识和沟通能力，能够热情、专业地与客户进行交流。熟悉销售、金融保险、产品等业务的基本知识和特点，能够为客户提供准确的信息和解决方案。拥有较强的销售能力和市场开拓能力，能够完成销售目标和任务。具备良好的应变能力和问题解决能力，能够在面对客户的不满和投诉时保持冷静，妥善处理。具备良好的团队合作精神和学习能力，能够不断提升自己的业务水平和综合素质。"
    }
]
    

df_jobs = pd.DataFrame(data)
df_jobs['岗位文本'] = df_jobs[['岗位名称', '岗位职责', '任职要求']].agg(' '.join, axis=1)

model = SentenceTransformer("../models/paraphrase-multilingual-MiniLM-L12-v2")

resume_embeddings = model.encode(df_resume["简历文本"].tolist(), show_progress_bar=True)
job_embeddings = model.encode(df_jobs["岗位文本"].tolist(), show_progress_bar=True)

similarity_matrix = cosine_similarity(resume_embeddings, job_embeddings)

top_n = 3
recommendations = []

for i, sims in enumerate(similarity_matrix):
    top_indices = sims.argsort()[-top_n:][::-1]
    top_jobs = df_jobs.iloc[top_indices]["岗位名称"].tolist()
    recommendations.append(top_jobs)

df_resume["岗位推荐Top{}".format(top_n)] = recommendations
df_resume.to_csv("../results/job_result.csv", index=False, encoding='utf-8-sig')